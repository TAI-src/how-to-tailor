name: Create Example PR

on:
  issues:
    types: [opened]

jobs:
  create_pr:
    if: contains(github.event.issue.labels.*.name, 'new-example')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Parse issue fields and export
        shell: bash
        run: |
          BODY="${{ github.event.issue.body }}"

          # Fields and headers
          FIELDS=("AUTHOR" "LINK" "PROBLEM" "WHY" "BASELINE" "PROCESS" "WHAT" "CHAR" "REFS" "CONTACT")
          HEADERS=("Author Name" "Link to publication / code" "Problem description" "Why was tailoring needed" "Baseline algorithm" "Tailoring process" "What was tailored" "Main problem characteristics" "References" "Contact information (optional)")

          # Use awk to extract between headings
          extract_field() {
            local start="$1"
            local end="$2"
            awk -v start="### $start" -v end="### $end" '
              $0 ~ start {flag=1; next}
              $0 ~ end {flag=0}
              flag {print}
            ' <<< "$BODY"
          }

          # Extract all fields
          for i in "${!FIELDS[@]}"; do
            VAR="${FIELDS[i]}"
            HEADER="${HEADERS[i]}"
            if [ $i -eq $((${#FIELDS[@]}-1)) ]; then
              VALUE=$(awk -v start="### $HEADER" ' $0 ~ start {flag=1; next} flag {print}' <<< "$BODY")
            else
              NEXT_HEADER="${HEADERS[i+1]}"
              VALUE=$(extract_field "$HEADER" "$NEXT_HEADER")
            fi
            # Trim whitespace
            VALUE="$(echo "$VALUE" | sed '/^[[:space:]]*$/d')"
            # Fallback
            [ -z "$VALUE" ] && VALUE="_No response_"
            # Exort to GitHub environment with multiline support
            {
              echo "$VAR<<EOF"
              echo "$VALUE"
              echo "EOF"
            } >> $GITHUB_ENV
          done
          # Also export the list of fields for later iteration
          echo "FIELDS=${FIELDS[*]}" >> $GITHUB_ENV

      - name: Create Markdown from template
        run: |
          cd how-to-tailor/docs/examples || exit 1
          LAST_ID=$(ls example_*.md 2>/dev/null | xargs -n1 basename | sed 's/[^0-9]*//g' | sort -n | tail -n1)
          if [ -z "$LAST_ID" ]; then LAST_ID=0; fi
          NEW_ID=$((LAST_ID + 1))
          # Export metadata
          export TITLE="${{ github.event.issue.title }}"
          export DATE=$(date +%Y-%m-%d)
          export ID="$NEW_ID"

          # Iterate over fields exported from previous step
          for VAR in $FIELDS; do
            export "$VAR=${!VAR}"
          done
          envsubst < example_template.md > example_${NEW_ID}.md

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "Add new example from issue #${{ github.event.issue.number }}"
          branch: "new-example-${{ github.event.issue.number }}"
          title: "Add new example: ${{ github.event.issue.title }}"
          body: |
            This PR adds a new example generated from issue #${{ github.event.issue.number }}.
            Closes #${{ github.event.issue.number }}.
          labels: example-added

