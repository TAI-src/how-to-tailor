name: Create Example PR

on:
  issues:
    types: [opened]

jobs:
  create_pr:
    if: contains(github.event.issue.labels.*.name, 'new-example')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Parse issue body (Markdown â†’ variables)
        id: parse
        run: |
         BODY="${{ github.event.issue.body }}"

         extract_field() {
          local start="$1"
          local end="$2"
          echo "$BODY" | sed -n "/^### $start/,/^### $end/p" | tail -n +2 | sed '/^###/d'
         }
         AUTHOR=$(extract_field "Author Name" "Links to publication / code")
         LINKS=$(extract_field "Links to publication / code" "Problem description")
         PROBLEM=$(extract_field "Problem description" "Why was tailoring needed")
         WHY=$(extract_field "Why was tailoring needed" "Baseline algorithm")
         BASELINE=$(extract_field "Baseline algorithm" "Tailoring process")
         PROCESS=$(extract_field "Tailoring process" "What was tailored")
         WHAT=$(extract_field "What was tailored" "Main problem characteristics")
         CHAR=$(echo "$BODY" | sed -n '/^### Main problem characteristics/,$p' | tail -n +2)

         # Trim leading/trailing whitespace
         AUTHOR=$(echo "$AUTHOR" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
         LINKS=$(echo "$LINKS" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
         PROBLEM=$(echo "$PROBLEM" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
         WHY=$(echo "$WHY" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
         BASELINE=$(echo "$BASELINE" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
         PROCESS=$(echo "$PROCESS" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
         WHAT=$(echo "$WHAT" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
         CHAR=$(echo "$CHAR" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

         # Export to environment
         echo "AUTHOR=$AUTHOR" >> $GITHUB_ENV
         echo "LINKS=$LINKS" >> $GITHUB_ENV
         echo "PROBLEM=$PROBLEM" >> $GITHUB_ENV
         echo "WHY=$WHY" >> $GITHUB_ENV
         echo "BASELINE=$BASELINE" >> $GITHUB_ENV
         echo "PROCESS=$PROCESS" >> $GITHUB_ENV
         echo "WHAT=$WHAT" >> $GITHUB_ENV
         echo "CHAR=$CHAR" >> $GITHUB_ENV

      - name: Create Markdown from template
        run: |
          cd how-to-tailor/docs/examples || exit 1
          LAST_ID=$(ls example_*.md 2>/dev/null | xargs -n1 basename | sed 's/[^0-9]*//g' | sort -n | tail -n1)
          if [ -z "$LAST_ID" ]; then LAST_ID=0; fi
          NEW_ID=$((LAST_ID + 1))
          export TITLE="${{ github.event.issue.title }}"
          export AUTHOR="$AUTHOR"
          export LINKS="$LINKS"
          export PROBLEM="$PROBLEM"
          export WHY="$WHY"
          export BASELINE="$BASELINE"
          export PROCESS="$PROCESS"
          export WHAT="$WHAT"
          export CHAR="$CHAR"
          export DATE=$(date +%Y-%m-%d)
          export ID="$NEW_ID"

          envsubst < ../example_template.md > example_${NEW_ID}.md

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "Add new example from issue #${{ github.event.issue.number }}"
          branch: "new-example-${{ github.event.issue.number }}"
          title: "Add new example: ${{ github.event.issue.title }}"
          body: |
            This PR adds a new example generated from issue #${{ github.event.issue.number }}.
          labels: example-added

